<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yeni Sipariş | SMM Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* TEMA RENKLERİ VE DEĞİŞKENLER */
        :root {
            --primary-color: #5d3f6a;       /* Kapalı Mor Vurgu */
            --bg-dark: #1e1e2d;             /* Koyu Arka Plan */
            --bg-card: #27293d;             /* Koyu Kart Arka Planı */
            --text-light: #e0e0e0;          /* Açık Metin */
            --text-secondary: #a9a9b6;      /* İkincil Metin */
            --border-dark: #3b3b51;         /* Koyu Sınır */
            --success-color: #28a745;       /* Yeşil (Başarılı) */
            --danger-color: #e74c3c;        /* Kırmızı (Hata) */
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* GENEL STİL */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        /* KAPSAYICI */
        .container {
            width: 100%;
            max-width: 1000px;
            padding: 20px;
        }

        /* BAŞLIK */
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 40px;
            font-weight: 700;
            border-bottom: 2px solid var(--border-dark);
            padding-bottom: 10px;
        }

        /* ANA SİPARİŞ KARTI */
        .order-card {
            background-color: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* BÖLÜM BAŞLIKLARI */
        .section-title {
            font-size: 1.4em;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed var(--border-dark);
        }

        /* FORM GRUBU */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* TÜM INPUT VE SELECTLER */
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-dark);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            background-color: var(--bg-dark);
            color: var(--text-light);
            transition: border-color 0.3s, box-shadow 0.3s;
            outline: none;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(93, 63, 106, 0.4);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* SERVİS SEÇİMİ (Grid Yapısı) */
        .service-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        /* PLATFORM SEÇİM BUTONU */
        .platform-button {
            background-color: var(--bg-dark);
            color: var(--text-secondary);
            border: 2px solid var(--border-dark);
            padding: 15px 10px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            user-select: none;
        }

        .platform-button i {
            font-size: 1.5em;
            color: var(--text-secondary);
            transition: color 0.3s;
        }

        .platform-button:hover {
            border-color: var(--primary-color);
            color: var(--text-light);
            box-shadow: var(--shadow-light);
        }

        .platform-button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .platform-button.active i {
            color: white;
        }

        /* ÖZET VE FİYAT */
        .summary-box {
            background-color: var(--bg-dark);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border-dark);
        }

        .summary-box p {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1.1em;
        }
        
        .summary-box .summary-label {
            color: var(--text-secondary);
        }

        .summary-box .total-price {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--success-color);
            border-top: 1px solid var(--border-dark);
            padding-top: 10px;
            margin-top: 15px;
        }

        /* SİPARİŞ BUTONU */
        .order-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 10px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            margin-top: 10px;
            box-shadow: 0 6px 15px rgba(93, 63, 106, 0.4);
        }

        .order-btn:hover {
            background-color: #4a3355; 
            transform: translateY(-2px);
        }

        .order-btn:disabled {
            background-color: var(--border-dark);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* MESAJ ALANI */
        #orderMessage {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            display: none;
        }
        .error { background-color: #3b2020; color: var(--danger-color); border: 1px solid var(--danger-color); }
        .success { background-color: #213c23; color: var(--success-color); border: 1px solid var(--success-color); }

        /* RESPONSIVE DÜZENLEME */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .order-card {
                padding: 20px;
            }
            .service-selection {
                grid-template-columns: 1fr 1fr; /* Mobil görünümde 2 sütun */
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Yeni Sosyal Medya Siparişi Oluştur</h1>

    <div class="order-card">
        <!-- PLATFORM SEÇİMİ -->
        <section>
            <div class="section-title"><i class="fas fa-cubes"></i> Platform Seçimi</div>
            <div class="service-selection" id="platformSelection">
                <!-- Her bir buton, data-platform niteliği ile platformu belirtir -->
                <div class="platform-button" data-platform="tiktok">
                    <i class="fab fa-tiktok"></i> TikTok
                </div>
                <div class="platform-button" data-platform="youtube">
                    <i class="fab fa-youtube"></i> YouTube
                </div>
                <div class="platform-button" data-platform="instagram">
                    <i class="fab fa-instagram"></i> Instagram
                </div>
                <div class="platform-button" data-platform="discord">
                    <i class="fab fa-discord"></i> Discord (Üye)
                </div>
                <div class="platform-button" data-platform="twitter">
                    <i class="fab fa-twitter"></i> X (Takipçi/Beğeni)
                </div>
            </div>
        </section>

        <!-- SERVİS TÜRÜ SEÇİMİ VE DETAYLAR -->
        <section>
            <div class="section-title"><i class="fas fa-list-alt"></i> Servis Türü ve Detayları</div>
            
            <!-- Servis Türü Seçimi -->
            <div class="form-group">
                <label for="serviceType">Servis Türü</label>
                <select id="serviceType">
                    <!-- Servisler JS ile platforma göre doldurulacak -->
                    <option value="">Önce platform seçin...</option>
                </select>
            </div>
            
            <!-- Servis Linki -->
            <div class="form-group">
                <label for="targetLink">Hedef Link (Video/Profil/Sunucu)</label>
                <input type="url" id="targetLink" placeholder="https://..." required>
            </div>

            <!-- Adet Girişi -->
            <div class="form-group">
                <label for="quantity">Adet / Miktar (Minimum 100)</label>
                <input type="number" id="quantity" min="100" value="100" required>
            </div>
            
            <!-- Yorumlar için Ek Alan (Sadece yorum seçilince görünür olacak) -->
            <div class="form-group" id="commentArea" style="display: none;">
                <label for="customComments">Özel Yorumlar (Her yorumu yeni bir satıra yazın)</label>
                <textarea id="customComments" placeholder="Harika bir video!\nÇok beğendim\nMükemmel içerik..."></textarea>
            </div>
        </section>

        <!-- SİPARİŞ ÖZETİ -->
        <section>
            <div class="section-title"><i class="fas fa-calculator"></i> Sipariş Özeti</div>
            <div class="summary-box">
                <p><span class="summary-label">Seçilen Platform:</span> <span id="summaryPlatform">--</span></p>
                <p><span class="summary-label">Seçilen Servis:</span> <span id="summaryService">--</span></p>
                <p><span class="summary-label">Miktar:</span> <span id="summaryQuantity">100</span></p>
                <p class="total-price"><span>Toplam Tutar (TL):</span> <span id="totalPrice">0.00</span></p>
            </div>
        </section>

        <!-- SİPARİŞ BUTONU VE MESAJI -->
        <button class="order-btn" id="btnPlaceOrder" disabled><i class="fas fa-shopping-cart"></i> Siparişi Tamamla</button>
        <div id="orderMessage" class="error"></div>
    </div>
</div>

<script type="module">
    // Firebase imports are minimized as this is a front-end UI for order creation.
    // However, if we were to process the order, we would need getFirestore, doc, addDoc, etc.
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, collection, addDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


    // --- CONFIGURATION AND INITIALIZATION ---
    // Global Firebase Variables
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

    // Initialize Firebase services
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Current user ID (will be updated on auth change)
    let currentUserId = null;

    // --- SERVICE DATA AND PRICING (Simulated Data) ---
    // Price is per 1000 units (Birim fiyat: TL / 1000 Adet)
    const SERVICES = {
        tiktok: [
            { name: "Takipçi (Hızlı)", type: "follower", pricePer1k: 25.50, min: 100 },
            { name: "Beğeni (Türk)", type: "like", pricePer1k: 12.00, min: 50 },
            { name: "İzlenme (Global)", type: "view", pricePer1k: 1.50, min: 1000 },
            { name: "Yorum (Özel)", type: "comment", pricePer1k: 45.00, min: 10 },
        ],
        youtube: [
            { name: "Abone (Garantili)", type: "subscriber", pricePer1k: 120.00, min: 50 },
            { name: "İzlenme (HD)", type: "view", pricePer1k: 4.50, min: 500 },
            { name: "Beğeni (Premium)", type: "like", pricePer1k: 30.00, min: 100 },
            { name: "Yorum (Özel)", type: "comment", pricePer1k: 55.00, min: 10 },
        ],
        instagram: [
            { name: "Takipçi (Gerçek)", type: "follower", pricePer1k: 18.00, min: 100 },
            { name: "Beğeni (Oto)", type: "like", pricePer1k: 9.00, min: 50 },
            { name: "İzlenme (Hikaye)", type: "view", pricePer1k: 0.80, min: 1000 },
            { name: "Yorum (Türk)", type: "comment", pricePer1k: 35.00, min: 10 },
        ],
        discord: [
            { name: "Sunucu Üyesi (Hızlı)", type: "member", pricePer1k: 80.00, min: 100 },
        ],
        twitter: [
            { name: "Takipçi (Hızlı)", type: "follower", pricePer1k: 20.00, min: 100 },
            { name: "Beğeni (Tweet)", type: "like", pricePer1k: 15.00, min: 50 },
        ]
    };

    // --- STATE VARIABLES ---
    let selectedPlatform = null;
    let selectedService = null;

    // --- DOM ELEMENTS ---
    const platformButtons = document.querySelectorAll('.platform-button');
    const serviceTypeSelect = document.getElementById('serviceType');
    const quantityInput = document.getElementById('quantity');
    const targetLinkInput = document.getElementById('targetLink');
    const commentArea = document.getElementById('commentArea');
    const customComments = document.getElementById('customComments');
    const btnPlaceOrder = document.getElementById('btnPlaceOrder');
    const orderMessage = document.getElementById('orderMessage');

    const summaryPlatform = document.getElementById('summaryPlatform');
    const summaryService = document.getElementById('summaryService');
    const summaryQuantity = document.getElementById('summaryQuantity');
    const totalPriceSpan = document.getElementById('totalPrice');

    // --- UTILITY FUNCTIONS ---

    /**
     * Shows a message to the user.
     * @param {string} message - The message text.
     * @param {boolean} isError - True for error, false for success.
     */
    function displayMessage(message, isError) {
        orderMessage.innerText = message;
        orderMessage.classList.remove('error', 'success');
        orderMessage.classList.add(isError ? 'error' : 'success');
        orderMessage.style.display = 'block';
        setTimeout(() => orderMessage.style.display = 'none', 5000);
    }

    /**
     * Calculates the total price based on quantity and service rate.
     * @param {number} quantity - The amount of service to buy.
     * @param {number} pricePer1k - The price per 1000 units.
     * @returns {number} The calculated total price.
     */
    function calculatePrice(quantity, pricePer1k) {
        if (quantity < 0 || !pricePer1k) return 0;
        return (quantity / 1000) * pricePer1k;
    }

    /**
     * Updates the service selection dropdown based on the chosen platform.
     * @param {string} platform - The selected platform key (e.g., 'tiktok').
     */
    function updateServiceDropdown(platform) {
        serviceTypeSelect.innerHTML = '';
        selectedService = null;
        commentArea.style.display = 'none';

        if (platform && SERVICES[platform]) {
            // Default option
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.innerText = "Lütfen bir servis seçin...";
            serviceTypeSelect.appendChild(defaultOption);

            SERVICES[platform].forEach((service, index) => {
                const option = document.createElement('option');
                option.value = index; // Use index to easily retrieve the object later
                option.innerText = `${service.name} (1K Fiyatı: ${service.pricePer1k.toFixed(2)} TL)`;
                serviceTypeSelect.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.value = "";
            option.innerText = "Platform seçimi gerekli.";
            serviceTypeSelect.appendChild(option);
        }
    }
    
    /**
     * Updates the order summary panel with current selections and calculated price.
     */
    function updateSummary() {
        const quantity = parseInt(quantityInput.value) || 0;
        
        // Update summary display
        summaryPlatform.textContent = selectedPlatform ? selectedPlatform.toUpperCase() : '--';
        summaryQuantity.textContent = quantity.toLocaleString('tr-TR');

        if (selectedService) {
            summaryService.textContent = selectedService.name;
            const price = calculatePrice(quantity, selectedService.pricePer1k);
            totalPriceSpan.textContent = price.toFixed(2);
            btnPlaceOrder.disabled = false;

            // Check if comment area should be visible
            if (selectedService.type === 'comment') {
                commentArea.style.display = 'block';
            } else {
                commentArea.style.display = 'none';
            }

            // Check for minimum quantity
            if (quantity < selectedService.min) {
                 displayMessage(`Bu servis için minimum miktar ${selectedService.min} olmalıdır.`, true);
                 btnPlaceOrder.disabled = true;
            } else {
                orderMessage.style.display = 'none'; // Hide error if quantity is okay
            }

        } else {
            summaryService.textContent = '--';
            totalPriceSpan.textContent = '0.00';
            btnPlaceOrder.disabled = true;
            commentArea.style.display = 'none';
        }
    }


    // --- EVENT HANDLERS ---

    /**
     * Handles platform button clicks.
     * @param {Event} e - The click event.
     */
    function handlePlatformClick(e) {
        let button = e.target.closest('.platform-button');
        if (!button) return;

        // Reset active state for all buttons
        platformButtons.forEach(btn => btn.classList.remove('active'));
        
        // Set active state for the clicked button
        button.classList.add('active');
        
        selectedPlatform = button.dataset.platform;
        
        // Update the service selection dropdown and summary
        updateServiceDropdown(selectedPlatform);
        updateSummary();
    }

    /**
     * Handles service type selection change.
     */
    function handleServiceChange() {
        const selectedIndex = serviceTypeSelect.value;
        if (selectedIndex !== "") {
            selectedService = SERVICES[selectedPlatform][parseInt(selectedIndex)];
        } else {
            selectedService = null;
        }
        updateSummary();
    }

    /**
     * Handles order submission (simulated and then sent to Firestore).
     */
    async function handlePlaceOrder() {
        if (!selectedPlatform || !selectedService) {
            return displayMessage("Lütfen platform ve servis seçimi yapın.", true);
        }

        const quantity = parseInt(quantityInput.value);
        const targetLink = targetLinkInput.value.trim();
        const comments = selectedService.type === 'comment' ? customComments.value.trim().split('\n').filter(c => c.length > 0) : null;
        const totalAmount = calculatePrice(quantity, selectedService.pricePer1k);

        if (quantity < selectedService.min || quantity <= 0 || !targetLink) {
            return displayMessage("Lütfen link, miktar ve diğer gerekli alanları kontrol edin.", true);
        }
        
        if (selectedService.type === 'comment' && (!comments || comments.length === 0)) {
            return displayMessage("Yorum servisi için en az bir yorum girmelisiniz.", true);
        }

        // --- FIREBASE ORDER SUBMISSION (SİPARİŞİ FIREBASE'E KAYDETME) ---
        // Save to Firestore: /artifacts/{appId}/users/{userId}/orders
        
        if (!currentUserId) {
             return displayMessage("Kullanıcı kimliği alınamadı. Lütfen giriş yapın veya anonim girişi bekleyin.", true);
        }

        const orderData = {
            platform: selectedPlatform,
            serviceName: selectedService.name,
            serviceType: selectedService.type,
            quantity: quantity,
            targetLink: targetLink,
            comments: comments,
            totalAmount: totalAmount,
            userId: currentUserId,
            orderDate: new Date(),
            status: 'Pending' // Initial status
        };

        btnPlaceOrder.disabled = true;
        btnPlaceOrder.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sipariş Oluşturuluyor...';

        try {
            // Add a new document to the 'orders' collection specific to the user
            const ordersCollectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'orders');
            await addDoc(ordersCollectionRef, orderData);

            displayMessage(`Siparişiniz (${selectedService.name}, ${quantity} Adet) başarıyla oluşturuldu! Tutar: ${totalAmount.toFixed(2)} TL`, false);
            
            // Reset form after success
            targetLinkInput.value = '';
            quantityInput.value = selectedService.min; 
            customComments.value = '';
            // Reset other selections (optional)
            // selectedPlatform = null; // Leaving selected for quick re-order

        } catch (error) {
            displayMessage(`Sipariş kaydı sırasında bir hata oluştu: ${error.message}`, true);
            console.error("Firestore Order Error:", error);
        } finally {
            btnPlaceOrder.disabled = false;
            btnPlaceOrder.innerHTML = '<i class="fas fa-shopping-cart"></i> Siparişi Tamamla';
            updateSummary(); // Re-check state just in case
        }
    }


    // --- INITIAL SETUP AND EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        // Platform Selection Listeners
        platformButtons.forEach(button => {
            button.addEventListener('click', handlePlatformClick);
        });

        // Service/Quantity/Link Listeners
        serviceTypeSelect.addEventListener('change', handleServiceChange);
        quantityInput.addEventListener('input', updateSummary);
        targetLinkInput.addEventListener('input', updateSummary); // Added link check functionality
        
        // Order Button Listener
        btnPlaceOrder.addEventListener('click', handlePlaceOrder);

        // Initial Summary Update
        updateSummary();
    });

    // --- FIREBASE AUTH LISTENER (Kullanıcı Kimliğini Almak İçin) ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUserId = user.uid;
            console.log("Authenticated User ID:", currentUserId);
        } else {
            currentUserId = null;
            // Handle scenario where user is logged out or anonymous
            console.log("User is not authenticated or is anonymous.");
            // Note: In a real app, you might want to redirect to login.html here.
        }
    });

</script>
</body>
</html>
