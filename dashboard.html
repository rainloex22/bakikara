<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MÃ¼ÅŸteri Paneli | bakikara.xyz</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* CSS BÃ–LÃœMÃœ - TEMA RENKLERÄ° */
        :root {
            --primary-color: #5d3f6a;      /* KapalÄ± Mor Vurgu */
            --bg-dark: #1e1e2d;             /* Koyu Arka Plan */
            --bg-card: #27293d;             /* Koyu Kart Arka PlanÄ± */
            --text-light: #e0e0e0;          /* AÃ§Ä±k Metin */
            --text-secondary: #a9a9b6;      /* Ä°kincil Metin */
            --border-dark: #3b3b51;         /* Koyu SÄ±nÄ±r */
            --danger-color: #e74c3c;        /* KÄ±rmÄ±zÄ± (Sil/Ã‡Ä±kÄ±ÅŸ) */
            --success-color: #28a745;       /* YeÅŸil (YayÄ±nda) */
            --warning-color: #ffc107;       /* SarÄ± (Onay Bekliyor) */
            --info-color: #007bff;          /* Mavi (Dosya Bekleniyor) */
            --shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-dark); color: var(--text-light); margin: 0; padding: 0; display: flex; min-height: 100vh; }
        h1, h2, h3 { font-family: 'Poppins', sans-serif; }
        .sidebar { width: 250px; background-color: var(--bg-card); padding: 20px 0; box-shadow: var(--shadow); display: flex; flex-direction: column; border-right: 1px solid var(--border-dark); flex-shrink: 0; }
        .logo { font-family: 'Poppins', sans-serif; font-size: 1.8em; font-weight: 700; margin: 0 0 40px 30px; color: var(--primary-color); }
        .nav-link { width: 100%; padding: 15px 30px; text-decoration: none; color: var(--text-secondary); display: flex; align-items: center; transition: background-color 0.3s, color 0.3s; cursor: pointer; }
        .nav-link i { margin-right: 15px; font-size: 1.1em; }
        .nav-link:hover, .nav-link.active { background-color: var(--bg-dark); color: var(--text-light); border-left: 4px solid var(--primary-color); }
        .logout-btn { margin-top: auto; padding: 15px 30px; width: 100%; border: none; background-color: var(--danger-color); color: white; cursor: pointer; font-weight: 600; transition: background-color 0.3s; }
        .logout-btn:hover { background-color: #c9302c; }
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid var(--border-dark); padding-bottom: 15px; }
        .welcome-msg { font-size: 1.8em; font-family: 'Poppins', sans-serif; font-weight: 700; }
        .welcome-msg strong { color: var(--primary-color); font-weight: 700; }
        .status-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .info-card { background: var(--bg-card); padding: 25px; border-radius: 8px; box-shadow: var(--shadow); border-left: 5px solid; transition: all 0.3s; }
        .info-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5); }
        .info-card h3 { margin-top: 0; font-family: 'Poppins', sans-serif; font-weight: 500; font-size: 1em; color: var(--text-secondary); }
        .card-value { font-size: 2.2em; font-weight: 700; margin-top: 5px; }
        .card-primary { border-left-color: var(--primary-color); }
        .card-success { border-left-color: var(--success-color); }
        .card-warning { border-left-color: var(--warning-color); }
        .card-info    { border-left-color: var(--info-color); }
        .card-danger  { border-left-color: var(--danger-color); }
        .card-primary .card-value { color: var(--primary-color); }
        .card-success .card-value { color: var(--success-color); }
        .card-warning .card-value { color: var(--warning-color); }
        .card-info .card-value    { color: var(--info-color); }
        .instruction-box { border: 1px solid var(--border-dark); background-color: var(--bg-card); padding: 30px; border-radius: 8px; margin-top: 20px; box-shadow: var(--shadow); }
        .instruction-box h3 { color: var(--warning-color); margin-top: 0; border-bottom: 1px solid var(--border-dark); padding-bottom: 10px; }
        .email-address { font-size: 1.3em; color: var(--primary-color); font-weight: 700; margin: 15px 0; display: block; }
        .hidden { display: none !important; }
        .action-btn { padding: 10px 25px; border-radius: 5px; font-weight: 600; cursor: pointer; transition: background-color 0.3s, transform 0.1s; border: none; }
        .action-btn:active { transform: scale(0.98); }
        .primary-btn { background-color: var(--primary-color); color: var(--text-light); }
        .primary-btn:hover { background-color: #4a3355; }
        .content-card { background: var(--bg-card); padding: 25px; border-radius: 8px; box-shadow: var(--shadow); margin-top: 20px; }
        .announcement-bar {
            background-color: var(--warning-color); 
            color: #333; 
            padding: 10px 20px; 
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: 600;
            display: none; /* JS ile gÃ¶sterilecek */
        }
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; padding: 10px 0; flex-direction: row; justify-content: space-around; border-right: none; border-bottom: 1px solid var(--border-dark); overflow-x: auto; }
            .sidebar .logo { display: none; }
            .sidebar .logout-btn { display: none; }
            .sidebar .nav-link { padding: 10px 15px; flex-direction: column; text-align: center; border-left: none !important; }
            .sidebar .nav-link i { margin: 0 0 5px 0; }
            .main-content { padding: 20px; }
            .status-cards { grid-template-columns: 1fr; }
            .welcome-msg { font-size: 1.3em; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">Baki Hosting</div>
    
    <a data-tab="dashboard" id="dashboardLink" class="nav-link active"><i class="fas fa-tachometer-alt"></i> Panelim</a>
    <a data-tab="fileUpload" id="fileUploadLink" class="nav-link"><i class="fas fa-file-upload"></i> Dosya YÃ¶n.</a>
    <a data-tab="billing" id="billingLink" class="nav-link"><i class="fas fa-credit-card"></i> FaturalandÄ±rma</a>
    <a data-tab="support" id="supportLink" class="nav-link"><i class="fas fa-question-circle"></i> Destek</a>
    <a data-tab="settings" id="settingsLink" class="nav-link"><i class="fas fa-cog"></i> Ayarlar</a>

    <button class="logout-btn" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> GÃ¼venli Ã‡Ä±kÄ±ÅŸ</button>
</div>

<div class="main-content">
    
    <div class="top-bar">
        <div class="welcome-msg">Merhaba, <strong id="userEmail">MÃ¼ÅŸteri</strong></div>
    </div>
    
    <div class="announcement-bar" id="adminAnnouncement">
        <i class="fas fa-bullhorn"></i> <span id="announcementText"></span>
    </div>

    <div id="dashboardContent" class="content-section">
        <h2>ğŸ“Š Genel Durum Paneli</h2>
        <div class="status-cards">
            
            <div class="info-card card-primary">
                <h3>Site Adresiniz (YÃ¶netici OnaylÄ±)</h3>
                <a id="siteUrlLink" target="_blank" style="text-decoration: none;">
                    <div class="card-value" id="siteUrl">YÃ¼kleniyor...</div>
                </a>
                <p style="font-size: 0.9em; margin: 0; color: var(--text-secondary);">YayÄ±ndaki sitenizin URL'si.</p>
            </div>

            <div class="info-card card-success">
                <h3>Hizmet Durumu</h3>
                <div class="card-value" id="serviceStatus">YÃ¼kleniyor...</div>
                <p style="font-size: 0.9em; margin: 0; color: var(--text-secondary);" id="serviceMessage">...</p>
            </div>

            <div class="info-card card-info">
                <h3>Hesap Bakiyesi</h3>
                <div class="card-value" id="accountBalance">â‚º YÃ¼kleniyor...</div>
                <p style="font-size: 0.9em; margin: 0; color: var(--text-secondary);">KullanÄ±labilir kredi miktarÄ±nÄ±z.</p>
            </div>
            
            <div class="info-card card-warning">
                <h3>KayÄ±t Tarihi</h3>
                <div class="card-value" id="serviceDuration">YÃ¼kleniyor...</div>
                <p style="font-size: 0.9em; margin: 0; color: var(--text-secondary);">HesabÄ±nÄ±zÄ±n oluÅŸturulduÄŸu tarih.</p>
            </div>
        </div>
        
        <h2>ğŸ“¤ Dosya GÃ¶nderim YÃ¶nergesi (HÄ±zlÄ± YayÄ±n)</h2>
        <div class="instruction-box">
            <h3>Sitenizin YayÄ±nlanmasÄ± Ä°Ã§in Son AdÄ±m</h3>
            <p>Web sitenizi (HTML, CSS, JS) tek bir **.zip** dosyasÄ± halinde sÄ±kÄ±ÅŸtÄ±rÄ±n. Sadece sitenizin ana dizinini iÃ§eren bir ZIP olmasÄ±na dikkat edin.</p>
            
            <p style="font-weight: bold; margin-top: 15px; color: var(--text-light);">ZIP DosyanÄ±zÄ± GÃ¶nderin:</p>
            
            <strong class="email-address">admin@bakikara.xyz</strong>
            <button onclick="handleCopy('admin@bakikara.xyz')" class="action-btn primary-btn" style="margin-top: 10px;">E-postayÄ± Kopyala ve GÃ¶nder</button>
            
            <p style="font-size: 0.9em; color: var(--text-secondary); margin-top: 20px;">DosyanÄ±z bize ulaÅŸtÄ±ÄŸÄ±nda, maks. **12 saat iÃ§inde** siteniz yayÄ±na alÄ±nÄ±r ve size onay e-postasÄ± gÃ¶nderilir.</p>
        </div>
    </div>

    <div id="fileUploadContent" class="content-section hidden">
        <h2><i class="fas fa-upload"></i> Dosya YÃ¶neticisi <span style="color: var(--warning-color); font-size: 0.8em;">(YakÄ±nda Aktif)</span></h2>
        <div class="content-card">
            <h3 style="color: var(--primary-color);">GeliÅŸmiÅŸ YÃ¼kleme Paneli Ã‡ok YakÄ±nda</h3>
            <p>Sitenizi ZIP gÃ¶ndermeden otomatik olarak yÃ¼klemeniz, anlÄ±k gÃ¼ncellemeniz ve yedeklemeniz iÃ§in FTP/SFTP destekli Dosya YÃ¶netimi paneli Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz.</p>
            <p>Bu sÃ¼re zarfÄ±nda, en hÄ±zlÄ± yÃ¶ntem olarak e-posta ile gÃ¶nderime devam edebilirsiniz. Her gÃ¶nderim anlÄ±k gÃ¼ncelleme demektir!</p>
            <p style="margin-top: 15px;">**HÄ±zlÄ± GÃ¼ncelleme Adresi:** <strong style="color: var(--danger-color);">admin@bakikara.xyz</strong></p>
        </div>
    </div>
    
    <div id="billingContent" class="content-section hidden">
        <h2><i class="fas fa-credit-card"></i> FaturalandÄ±rma & Ã–deme</h2>
        <div class="content-card">
            <h3 style="color: var(--info-color);">Mevcut Kredi ve GeÃ§miÅŸ Ä°ÅŸlemler</h3>
            <p>**Mevcut Bakiye:** <strong id="billingBalance" style="color: var(--info-color);">â‚º YÃ¼kleniyor...</strong></p>
            <p>Son Ã–deme Tarihiniz: <strong id="lastPaymentDate">YÃ¼kleniyor...</strong></p>
            <hr style="border-color: var(--border-dark); margin: 25px 0;">
            <h3 style="color: var(--success-color);">Kredi YÃ¼kle / Hizmet Yenile</h3>
            <p>Hizmetinizi kesintisiz sÃ¼rdÃ¼rmek iÃ§in kredi yÃ¼klemesi yapabilirsiniz.</p>
            <button onclick="alert('Ã–deme sayfasÄ±na yÃ¶nlendiriliyor...')" class="action-btn primary-btn" style="background-color: var(--success-color); margin-top: 15px;">
                <i class="fas fa-wallet"></i> GÃ¼venli Ã–deme Yap
            </button>
            <p style="font-size: 0.9em; color: var(--text-secondary); margin-top: 15px;">TÃ¼m Ã¶deme iÅŸlemleriniz yÃ¼ksek gÃ¼venlik standartlarÄ±yla korunmaktadÄ±r.</p>
        </div>
    </div>

    <div id="supportContent" class="content-section hidden">
        <h2><i class="fas fa-headset"></i> Premium Destek Merkezi</h2>
        <div class="content-card">
            <h3 style="color: var(--success-color);">7/24 Teknik Destek</h3>
            <p>Her tÃ¼rlÃ¼ teknik sorun, acil durum veya bilgi talebi iÃ§in direkt olarak bize ulaÅŸÄ±n. Ekibimiz anÄ±nda size yanÄ±t verecektir.</p>
            <p style="margin-top: 15px;">**Acil Destek E-postasÄ±:** <a href="mailto:admin@bakikara.xyz" style="color: var(--warning-color); font-weight: bold;">admin@bakikara.xyz</a></p>
            <button onclick="handleCopy('admin@bakikara.xyz')" class="action-btn primary-btn" style="background-color: var(--warning-color); margin-top: 15px;">
                <i class="fas fa-envelope"></i> E-posta Kopyala ve GÃ¶nder
            </button>
            <hr style="border-color: var(--border-dark); margin: 25px 0;">
            <h3 style="color: var(--primary-color);">Bilgi BankasÄ±</h3>
            <p>SÄ±kÃ§a sorulan sorular, kurulum rehberleri ve ipuÃ§larÄ± iÃ§eren detaylÄ± bilgi bankamÄ±z Ã§ok yakÄ±nda yayÄ±nda.</p>
        </div>
    </div>

    <div id="settingsContent" class="content-section hidden">
        <h2><i class="fas fa-user-shield"></i> Hesap GÃ¼venliÄŸi ve AyarlarÄ±</h2>
        <div class="content-card">
            <p>**YÃ¶netici Notu:** <strong id="settingsAdminNotes" style="color: var(--warning-color);">YÃ¼kleniyor...</strong></p>
            <hr style="border-color: var(--border-dark); margin: 15px 0;">
            <p>**MÃ¼ÅŸteri ID:** <strong id="settingsUID">YÃ¼kleniyor...</strong></p>
            <p>E-posta Adresiniz: <strong id="settingsEmail">YÃ¼kleniyor...</strong></p>
            <p>KayÄ±t Tarihi: <strong id="settingsRegDate">YÃ¼kleniyor...</strong></p>
            <hr style="border-color: var(--border-dark); margin: 25px 0;">
            <h3 style="color: var(--danger-color);">Åifre / Hesap GÃ¼ncelleme</h3>
            <p>Hesap gÃ¼venliÄŸiniz iÃ§in ÅŸifre deÄŸiÅŸikliÄŸi veya kritik bilgi gÃ¼ncellemeleri destek ekibimiz tarafÄ±ndan doÄŸrulanmalÄ±dÄ±r.</p>
            <button onclick="switchContent('support')" class="action-btn primary-btn" style="background-color: var(--danger-color); margin-top: 15px;">
                <i class="fas fa-lock"></i> GÃ¼venlik Talebi OluÅŸtur
            </button>
        </div>
    </div>

</div>

<script type="module">
    // ----------------------------------------------------------------------
    // ğŸ”¥ ADIM 1: SUPABASE BAÄLANTI AYARLARI (Login.html ile aynÄ± olmalÄ±)
    // ----------------------------------------------------------------------
    const SUPABASE_URL = 'https://rqbbxjuncwwgtkbcqtet.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxYmJ4anVuY3d3Z3RrYmNxdGV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzM1NjAsImV4cCI6MjA3ODAwOTU2MH0.8dzDoL8MEgbrL7b-ocJ79c9ts9qtSbFT3EashQZXyZQ'; 
    
    // Supabase KÃ¼tÃ¼phanesini iÃ§eri aktar
    const { createClient } = supabase; 
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Tablo Ä°simleri Sabitleri
    const CUSTOMER_TABLE = 'customers'; // KullanÄ±cÄ± verilerinin tutulduÄŸu tablo
    const ANNOUNCEMENTS_TABLE = 'announcements'; // DuyurularÄ±n tutulduÄŸu tablo

    const FALLBACK_SITE_DOMAIN = 'bakikara.xyz'; // VarsayÄ±lan site domaini

    // --- YARDIMCI FONKSÄ°YONLAR ---
    
    function updateCard(elementId, value, messageId = null, message = null) {
        const element = document.getElementById(elementId);
        if (element) element.innerHTML = value;
        if (messageId && message) {
            const msgElement = document.getElementById(messageId);
            if (msgElement) msgElement.innerText = message;
        }
    }
    
    function setLoadingState() {
        // TÃ¼m kartlarÄ± 'YÃ¼kleniyor...' durumuna getir
        updateCard('userEmail', 'Veriler YÃ¼kleniyor...');
        updateCard('siteUrl', 'YÃ¼kleniyor...');
        updateCard('serviceStatus', 'Kontrol Ediliyor...');
        updateCard('serviceDuration', '...');
        updateCard('accountBalance', 'â‚º ...');
        updateCard('billingBalance', 'â‚º ...');
        updateCard('lastPaymentDate', '...');
        updateCard('settingsUID', '...');
        updateCard('settingsEmail', '...');
        updateCard('settingsRegDate', '...');
        updateCard('settingsAdminNotes', '...');
        document.getElementById('siteUrlLink').href = '#';
        const statusCard = document.getElementById('serviceStatus').parentElement;
        statusCard.className = 'info-card card-warning'; // YÃ¼kleme sÄ±rasÄ±nda varsayÄ±lan sarÄ±
    }
    
    // Tarih formatlama 
    function formatDate(timestamp) {
        if (!timestamp) return 'Bilinmiyor';
        
        let date;
        // Supabase'den gelen ISO string'i Date nesnesine Ã§evir
        date = new Date(timestamp);
        
        // GeÃ§ersiz tarihse
        if (isNaN(date)) return 'Bilinmiyor'; 
        
        return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    // Durum metnini ve rengini admin panelindeki ile uyumlu hale getirir
    function getStatusInfo(status) {
        switch (status) {
            case 'ACTIVE':
                return { text: 'âœ… YAYINDA', message: 'Tebrikler! Siteniz baÅŸarÄ±lÄ± bir ÅŸekilde yayÄ±nda.', color: 'card-success' };
            case 'PENDING':
                return { text: 'ğŸ” Onay Bekliyor', message: 'DosyanÄ±z ekibimize ulaÅŸtÄ±. YayÄ±n iÃ§in son kontroller yapÄ±lÄ±yor.', color: 'card-warning' };
            case 'SUSPENDED':
                return { text: 'âŒ ASKIYA ALINDI', message: 'Hizmetiniz askÄ±ya alÄ±nmÄ±ÅŸtÄ±r. Destek ile iletiÅŸime geÃ§in.', color: 'card-danger' };
            case 'PASSIVE':
                return { text: 'â³ PASÄ°F', message: 'Hizmetiniz pasif durumdadÄ±r. Yenileme/YÃ¼kleme bekliyor.', color: 'card-info' };
            case 'FILE_WAITING':
            default:
                return { text: 'ğŸ“¤ Dosya Bekleniyor', message: 'YayÄ±n iÃ§in sitenizi (zip) e-posta ile bekliyoruz.', color: 'card-info' };
        }
    }
    
    // En son duyuruyu Ã§eker ve gÃ¶sterir (Supabase'e uyarlandÄ±)
    function listenForLatestAnnouncement() {
        supabaseClient
            .from(ANNOUNCEMENTS_TABLE)
            .select('text')
            .order('createdAt', { ascending: false })
            .limit(1)
            .then(({ data, error }) => {
                const announcementBar = document.getElementById('adminAnnouncement');
                const announcementText = document.getElementById('announcementText');
                
                if (error || !data || data.length === 0) {
                    console.error("Duyuru Ã§ekilirken hata:", error);
                    announcementBar.style.display = 'none';
                    return;
                }
                
                const latest = data[0];
                announcementText.innerText = latest.text;
                announcementBar.style.display = 'block';
            });
    }

    // --- NAVÄ°GASYON, KOPYALAMA ve Ã‡IKIÅ ---
    window.switchContent = function(newTab) {
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.add('hidden');
        });
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        const newContent = document.getElementById(newTab + 'Content');
        if (newContent) {
            newContent.classList.remove('hidden');
        }
        const activeNavLink = document.querySelector(`.nav-link[data-tab="${newTab}"]`);
        if (activeNavLink) {
            activeNavLink.classList.add('active');
        }
    }

    window.handleCopy = function(text) {
        const tempInput = document.createElement('input');
        document.body.appendChild(tempInput);
        tempInput.setAttribute('value', text);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        alert(`âœ… ${text} adresi panoya kopyalandÄ±!`); 
    }

    // Supabase Ã‡Ä±kÄ±ÅŸ Ä°ÅŸlemi
    window.handleLogout = function() {
        if (!confirm('GÃ¼venli Ã§Ä±kÄ±ÅŸ yapmak istediÄŸinizden emin misiniz?')) {
            return;
        }
        
        supabaseClient.auth.signOut().then(() => {
             // Supabase oturumu sonlandÄ±rÄ±ldÄ±
             window.location.href = 'login.html'; // GiriÅŸ sayfasÄ±na yÃ¶nlendir
        }).catch((error) => {
            console.error("Ã‡Ä±kÄ±ÅŸ hatasÄ±:", error);
            alert('âŒ Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken bir sorun oluÅŸtu. LÃ¼tfen tekrar deneyin.');
            window.location.href = 'login.html'; // Hata olsa bile yÃ¶nlendir
        });
    }

    // --- BAÅLATMA VE VERÄ° AKIÅI ---

    // Supabase'den gelen veriyi iÅŸleyen fonksiyon
    function processUserData(userData, user) {
        if (!userData) {
             console.error("KullanÄ±cÄ± verisi boÅŸ.");
             return;
        }
        
        const displayEmail = user.email || 'Bilinmiyor';
        const username = displayEmail.split('@')[0];

        // --- VERÄ°LER ---
        // Supabase'de 'created_at' veya 'createdAt' kullanÄ±labilir.
        const regDate = userData.created_at || userData.createdAt; 
        const balance = userData.balance || 0.00; 
        const lastPayment = userData.lastPayment;
        const serviceStatus = userData.serviceStatus || 'FILE_WAITING'; 
        const siteAdi = userData.site_adi || username; 
        const adminNotes = userData.admin_notes || 'YÃ¶netici tarafÄ±ndan henÃ¼z not eklenmemiÅŸ.';
        
        const statusCard = document.getElementById('serviceStatus').parentElement;
        const statusInfo = getStatusInfo(serviceStatus);

        // --- KART VERÄ°LERÄ°NÄ° GÃœNCELLEME ---
        
        // 1. Site Adresi
        const sitePath = `${FALLBACK_SITE_DOMAIN}/${siteAdi}`; 
        updateCard('siteUrl', sitePath);
        document.getElementById('siteUrlLink').href = `http://${sitePath}`;

        // 2. Hizmet Durumu
        statusCard.className = `info-card ${statusInfo.color}`;
        updateCard('serviceStatus', statusInfo.text, 'serviceMessage', statusInfo.message);
        
        // 3. Hesap Bakiyesi
        updateCard('accountBalance', `â‚º ${parseFloat(balance).toFixed(2)}`);
        updateCard('billingBalance', `â‚º ${parseFloat(balance).toFixed(2)}`); 

        // 4. KayÄ±t Tarihi 
        updateCard('serviceDuration', formatDate(regDate));
        
        // --- DÄ°ÄER SEKME VERÄ°LERÄ° ---
        updateCard('lastPaymentDate', formatDate(lastPayment)); 

        // Ayarlar Sekmesi Verileri
        updateCard('settingsUID', user.id); // Supabase user ID
        updateCard('settingsEmail', displayEmail);
        updateCard('settingsRegDate', formatDate(regDate));
        updateCard('settingsAdminNotes', adminNotes);
    }

    function handleDataFetchError() {
        updateCard('userEmail', 'Veri Ã‡ekme HatasÄ±! ğŸ˜µ');
        const statusCard = document.getElementById('serviceStatus').parentElement;
        statusCard.className = 'info-card card-danger';
        updateCard('serviceStatus', 'VERÄ° HATASI', 'serviceMessage', 'Veri akÄ±ÅŸÄ± kesildi. SayfayÄ± yenileyin.');
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Navigasyon tÄ±klamalarÄ±nÄ± baÄŸla
        document.querySelectorAll('.nav-link').forEach(linkElement => {
            linkElement.addEventListener('click', (e) => { 
                e.preventDefault(); 
                switchContent(linkElement.getAttribute('data-tab'));
            });
        });
        switchContent('dashboard');
        
        setLoadingState();
        listenForLatestAnnouncement(); // Duyuru dinleyicisini baÅŸlat

        // Oturum KontrolÃ¼ ve Veri Ã‡ekme (Supabase)
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            if (!session) {
                // Oturum yoksa veya geÃ§ersizse direkt login'e at
                window.location.href = 'login.html';
                return;
            }
            
            const user = session.user; // Supabase user object
            
            const displayEmail = user.email || 'Bilinmiyor';
            const username = displayEmail.split('@')[0];
            const upperUsername = username.charAt(0).toUpperCase() + username.slice(1);
            
            updateCard('userEmail', `<strong>${upperUsername}</strong>`);
            
            // Supabase GerÃ§ek ZamanlÄ± Dinleyici (Customer verisi iÃ§in)
            supabaseClient
                .channel('customer_data')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: CUSTOMER_TABLE, filter: `user_id=eq.${user.id}` },
                    (payload) => {
                        processUserData(payload.new || payload.old, user); // Yeni veriyi iÅŸle
                    }
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        // Ä°lk veriyi Ã§ekmek iÃ§in bir SELECT sorgusu yap
                        supabaseClient
                            .from(CUSTOMER_TABLE)
                            .select('*')
                            .eq('user_id', user.id)
                            .single() // Tek bir sonuÃ§ bekliyoruz
                            .then(({ data, error }) => {
                                if (error) {
                                    console.error("Initial Supabase data fetch error:", error);
                                    handleDataFetchError();
                                    return;
                                }
                                processUserData(data, user);
                            });
                    } else if (status === 'CHANNEL_ERROR') {
                        console.error("Supabase Realtime Channel Error:", status);
                        handleDataFetchError();
                    }
                });

        }).catch(error => {
            // getSession() hatasÄ± veya aÄŸ hatasÄ±
            console.error("Kritik Oturum HatasÄ±:", error);
            window.location.href = 'login.html';
        });
    });
</script>
</body>
</html>
