<div id="messageBox"></div>

    <footer class="bg-gray-900 text-gray-500 text-center p-4 mt-auto">
        © 2025 BAKİ S2 Yönetim Hizmetleri.
    </footer>

    <script>
        // Bu script, herhangi bir modül hatası olsa bile body'yi görünür yapar.
        document.addEventListener('DOMContentLoaded', () => {
            document.body.style.opacity = '1';
        });
    </script>

    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script type="module" src="./firebase-auth-service.js"></script>
    
    <script type="module">
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { app } from "./firebase-auth-service.js"; 

        const auth = getAuth(app);
        const db = getFirestore(app);
        const loggedOutNav = document.getElementById('loggedOutNav');
        const loggedInNav = document.getElementById('loggedInNav');

        function getInitials(name) {
            if (!name) return '??';
            const parts = name.split(' ');
            if (parts.length > 1) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return name[0].toUpperCase();
        }

        async function updateHeaderUI(user) {
            if (loggedOutNav && loggedInNav) {
                if (user && !user.isAnonymous) {
                    loggedOutNav.classList.add('hidden');
                    loggedInNav.classList.remove('hidden');

                    const navDisplayName = document.getElementById('nav_display_name');
                    const navUserRole = document.getElementById('nav_user_role');
                    const navProfileInitials = document.getElementById('nav_profile_initials');
                    
                    let displayName = user.displayName || user.email.split('@')[0];
                    let accountType = "STANDART";
                    
                    try {
                        const docSnap = await getDoc(doc(db, "users", user.uid));
                        if (docSnap.exists()) {
                            accountType = docSnap.data().accountType || "STANDART";
                        }
                    } catch (e) {
                        console.error("Firestore veri çekme hatası:", e);
                    }

                    if (navDisplayName) navDisplayName.textContent = displayName;
                    if (navUserRole) navUserRole.textContent = accountType;
                    if (navProfileInitials) navProfileInitials.textContent = getInitials(displayName);

                } else {
                    loggedOutNav.classList.remove('hidden');
                    loggedInNav.classList.add('hidden');
                }
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                window.location.href = 'girisyap.html'; 
            } catch (error) {
                console.error("Çıkış hatası:", error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            updateHeaderUI(user);
        });

        // Logout butonuna olayı bağlama (Dropdown içinde)
        document.getElementById('logoutButtonNav')?.addEventListener('click', handleLogout);

        // --- YARDIM SAYFASINA ÖZEL: Akordiyon (Sıkça Sorulan Sorular) Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.accordion-item').forEach(item => {
                item.addEventListener('click', () => {
                    const targetId = item.getAttribute('data-target');
                    const content = document.getElementById(targetId);
                    const icon = item.querySelector('.fa-chevron-down');

                    const isCurrentlyHidden = content.classList.contains('hidden');
                    
                    // Tüm açık olanları kapat ve iconları sıfırla
                    document.querySelectorAll('.accordion-item p').forEach(p => p.classList.add('hidden'));
                    document.querySelectorAll('.accordion-item i').forEach(i => i.classList.remove('rotate-180'));

                    if (isCurrentlyHidden) {
                        // Sadece tıklananı aç
                        content.classList.remove('hidden');
                        icon.classList.add('rotate-180');
                    }
                });
            });
            
            // YENİ: Dropdown açma/kapama JS'i
            document.getElementById('profileMenuButton')?.addEventListener('click', (e) => {
                e.stopPropagation();
                const dropdown = document.getElementById('profileDropdown');
                dropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', (event) => {
                const menu = document.getElementById('loggedInNav');
                const isClickInside = menu?.contains(event.target);
                if (!isClickInside) {
                    document.getElementById('profileDropdown')?.classList.add('hidden');
                }
            });
        });

        // Sayfa yüklendiğinde Firebase başlatma işlemini başlat
        window.onload = window.startClient;
    </script>
</body>
</html>
